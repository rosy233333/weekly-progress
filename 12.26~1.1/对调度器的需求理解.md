# 对调度器的需求理解

时间：2023/12/27

## 运行的计算机系统的情况

只有进程和协程的概念，没有线程。使用协程可以在多个核上运行同一个进程。用`Task`类表示进程或协程。（**关于进程的问题1**）

使用调度频率较高的协作式调度来近似抢占式调度，因此协程不会被中途打断，只会在运行到await点时发生调度。

## 协程调度

调度器调度的对象：`TaskRef`（8字节）

### 协程的切换

1. 调度一个处于就绪状态的 `Task`；
2. 准备好运行栈；（**关于调度器的问题2**）

接口：`fetch() -> Option<TaskRef>`

### 协程的唤醒

1. 将被唤醒的协程加入调度器；

接口：`spawn(task_ref: TaskRef)`

## 中断

1. 设置中断向量表

接口：`lidt(idt: Idt)`，设置中断向量表，其中保存对应的中断处理 TaskRef

2. 在中断到来时，将中断处理TaskRef加入最高优先级队列（**关于调度器的问题3**）

## 关于调度器的问题

1. 调度器是以进程为边界，调度同一进程内部的各协程吗？还是将所有进程的协程放在一起调度？如果是前者，那在进程切换时需要保存和加载当前进程的调度队列，是在CPU的协助下进行保存加载，还是让调度器直连内存？如果是后者，那需要在某个核心当前运行的协程和下一个运行的协程，所属不同的进程，则进行进程切换（这个我觉得不太现实……）。

    **学长解答**：调度器为整个系统服务，但内部有多个 Executor，Executor 以进程为边界，只会调度单个进程内的协程。进程切换和调度协程时不需要读写内存。

    对于这个问题，那么是否是：每个进程创建的时候，调度器也为进程分配一个Executor，进行调度时，根据发出调度请求的进程，使用对应的Executor来处理调度请求？

    **学长解答**：分配的工作是由内核完成的，然后取出协程是软件从分配的 Executor 中取出

    那么，Executor是调度器内部的结构吗？如果是，在请求调度器进行调度时，调度器如何知道使用哪个Executor来调度呢？（例如，是否需要在接口中，加入类似“Executor id”这样的参数）

    **学长解答**：Executor 在调度器内部，进程切换过去后，会把对应的 Executor id 传递到用户态，用户态的执行函数根据这个进行。这个需要增加一个内核管理调度器 Executor 的接口，但是你现在的毕设中我觉得不需要涉及到这部分，因为我想的是在 unikernel 下先把中断的部分处理好，如果我们两一起行动比较快的话，就可以把后续的多进程、系统调用的部分完善
   
2. 为何要准备运行栈？（是为了恢复函数调用关系吗？）如何保存和准备运行栈？（比如说，能否保存在`Task`对象中？）

    **学长解答**：运行栈，只要每个进程一个就可以，如果说一个进程分配了多个核，则准备与分配的核数量相等的栈，这个在进程切换到用户态的时候准备就可以了，保存在对应的上下文中，协程也是一个函数，它的运行也需要栈，但是它在可以让出的时候把栈清空了，所以这里需要运行栈
   
3. 调度器如何接收中断？是将调度器同时作为中断控制器，从各个中断源直接接收中断，还是让调度器从现有的中断控制器处获取中断？

    **学长解答**：我的想法是调度器集成跟 plic 一样的中断控制器功能，直接连中断线

## 关于进程和主核的问题

**学长解答**：我的毕设不涉及多进程，可以暂时不考虑。

1. 一个进程内可能包含多个协程？如果进程和协程都用`Task`表示，如何实现这个包含关系？

    **学长解答**：主核调度到进程 fut 时，会通过 ipi 和参数，唤醒其他的核，然后其他的核会进入到用户态执行目标进程

    （我的想法：所以这就是我在4里说的那个“主协程”的模型？）
   
2. 主核需要从任务调度器获取进程对应的`fut`，这需要任务调度器实现什么新的功能吗？

    **学长解答**：这个不需要新增功能
   
3. 同一时间，不同的核可以运行多个进程吗？还是只能运行同一个进程？

    **学长解答**：同一时间，可以运行多个核，可以在不同的核上运行不同的进程

4. 主核的作用是什么？其是否对应于每个进程需要一个“主协程”，然后由“主协程”在其它核上启动其它协程？

    **学长解答**：你可以看看，rCoreN 里面的用户态程序是如何运行的，其他的协程不是凭空生成的，main 协程会创建其他的协程