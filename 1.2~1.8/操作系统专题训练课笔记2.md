# 操作系统专题训练课笔记

时间：2024/1/4

原文：[https://www.xuetangx.com/course/THU0809100czxt/14294493](https://www.xuetangx.com/course/THU0809100czxt/14294493)

## 软硬系统的用户态中断机制

### RISCV N扩展（似乎现在已废弃）

![](../图片/屏幕截图%202024-01-04%20143926.png)

中断委托：将U态的中断委托到S态处理

![](../图片/屏幕截图%202024-01-04%20144348.png)

（中断可以屏蔽，异常不能屏蔽）

![](../图片/屏幕截图%202024-01-04%20144617.png)

将中断分为硬件中断和软件中断，前者指外设硬件发来的中断，后者指处理器不同核心间发送的中断。

### PLIC外设中断控制器（硬件中断）

使用于【硬件多，核少】的情况

![](../图片/屏幕截图%202024-01-04%20144659.png)

中断上下文

处理器中有一个pending位，PLIC会将这个位置1，使处理器知道有中断，之后处理器从PLIC领取中断信息，之后PLIC再看是否有其它中断，要不要发

![](../图片/屏幕截图%202024-01-04%20144916.png)

### UINTC用户态中断控制器（软件中断）

![](../图片/屏幕截图%202024-01-04%20145109.png)

S和R的数量都较少

现有的(A)CLINT是指定CPU核心作为中断目标的，但软件和CPU核心之间不是一一对应。

本报告提出了一种以软件作为中断目标的方案。

![](../图片/屏幕截图%202024-01-04%20145636.png)

![](../图片/屏幕截图%202024-01-04%20145705.png)

处理流程：

![](../图片/屏幕截图%202024-01-04%20150048.png)

（发送方/接收方对应软件进程，中断上下文对应CPU核心）

### 详细设计

![](../图片/屏幕截图%202024-01-04%20150459.png)

![](../图片/屏幕截图%202024-01-04%20150534.png)

![](../图片/屏幕截图%202024-01-04%20150706.png)

![](../图片/屏幕截图%202024-01-04%20150736.png)

（目前还未设计用户态直接访问时钟）

![](../图片/屏幕截图%202024-01-04%20150814.png)

![](../图片/屏幕截图%202024-01-04%20150847.png)

![](../图片/屏幕截图%202024-01-04%20150857.png)

## RISC-V用户态中断扩展设计与实现

![](../图片/屏幕截图%202024-01-04%20161028.png)

![](../图片/屏幕截图%202024-01-04%20161441.png)

### 硬件实现

![](../图片/屏幕截图%202024-01-04%20161515.png)

可以去看这个仓库（重点看中断的触发，以及virt添加外设信息）

[https://github.com/U-interrupt/uintr/blob/main/doc/qemu-journal.md](https://github.com/U-interrupt/uintr/blob/main/doc/qemu-journal.md) 中有很多QEMU RISC-V编程的笔记