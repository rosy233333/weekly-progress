# Unifying the User and Kernel Environments阅读笔记

## 基本信息

发表时间：1997年

研究单位：Microsoft Research

## Abstract

在一个交互式电视操作系统中，将用户态和内核态环境统一。体现在以下方面：

- 接口
- 运行时要求
- 文档
- 调试器

统一内核和用户环境的系统能够自动地支持透明内核加载——将可信的用户态程序。测试程序移入内核。其具有软件工程上的优势，因为为用户态和内核态只需要开发一套程序。并且可以降低内存使用、提高性能。

## Introduction

在本文研究的系统（Rialto）中，设备驱动、文件系统、网络栈等内核级别的子系统为分别加载的二进制文件，并且与用户态使用相同的接口、库函数和调试器。

用户态的接口在内核态中继续可用。内核态不会对程序做出抢占、调度、共享库使用或栈空间上的限制。

本文解决的技术问题：

- 为内核访问系统调用和远程过程调用提供了安全、高效和透明的接口
- 为共享库跨越用户/内核边界提供了不需要PIC的机制
- 可动态增长、可分页的内核栈

## Related Work

Multics：提供了用户和系统编程的统一环境。每个进程包含了不同特权级的段（包括内核的段），进程的特权级仅决定它能访问哪些段。但它的实现依赖于特定的、已过时（即使对论文发表的1997年来说，也已经有30年的历史了）的硬件。

Chorus和Mach的一些版本：通过监管者任务（supervisor task）支持内核移植（kernel collocation）。监管者任务是由用户创建、但运行在内核态的任务。监管者任务间的IPC可以被简化。但这种简化不是透明的，因此造成了用户态和内核态的接口不同。

微内核系统将所有开发放在用户态，消除了内核态开发环境。例如，L4将设备驱动放在用户态，内核将设备中断变为IPC转发给驱动进程。exo-kernel最大程度地取消了内核的资源管理功能，而是让内核将硬件资源安全地暴露给用户态。

一些可延伸内核支持将代码安全地注入内核，同时保护内核不受恶意代码的影响。但这样增大了用户和内核的接口区别。本文的系统没有进行保护，而是通过提供统一调试器，使代码在引入内核前可以先在用户态调试，从而实现保护内核的功能。

## Software-Engineering Examples

一些软件系统的开发能够从用户内核环境统一中获益，例如Andrew File System（AFS）、Windows NT Win32子系统、DCE RPC运行时。

AFS：将其用户级缓存管理器移到内核中，可以提高性能、实现更多功能、增加可移植性（因为内核级API比用户级API的标准更统一）

Windows NT Win32子系统：在早期，将Win32 GUI子系统实现为用户进程。4.0版本后，移入内核以提高性能。而用户与内核接口的区别（主要是系统调用与IPC的区别），使得这次移植导致了子系统的部分重构。

DCE RPC运行时：需要为用户和内核提供两个版本。

## Unifying User-Level and Kernel-Level Interfaces

出于性能考虑，一些对性能敏感的程序需要在用户态和内核态提供不同的专用接口。

**本节讨论，对于一个通用操作系统，是否需要统一接口？**

早期Unix的用户态和内核态环境：

- 用户程序的二进制文件作为进程加载进用户空间
- 驱动程序与内核一同编译进内核映像
- 内核代码和数据不会进行分页或换入换出
- 内核代码无法被抢占
- 内核代码不支持多线程、多处理器

当时的内核态环境很简单。

随着发展，内核态支持动态加载的驱动和子系统，支持线程、抢占和分页。

如今，用户态和内核态的功能有许多重叠，但接口上却很少相同。

![alt text](image.png)

对于更复杂、更数据集中型的接口（例如文件和网络I/O），能否进行用户态和内核态的接口统一？首先，已有不需拷贝，跨地址空间进行数据传输的方案；其次，可以为每个模块创建“内部接口”和“外部接口”两组接口。内部接口在模块与其合作者位于同一环境时使用（无论是内核态还是用户态），而外部接口在位于不同环境时使用。

### Device Drivers

在中断处理的情况下，本文不建议进行用户态和内核态的接口统一。本节考虑，是否能够在一组专用于内核态的API和用户态内核态统一的API下开发设备驱动程序。

许多设备驱动需要注册first-level中断处理程序。中断处理程序运行在内核中，且中断处理程序中对调度和抢占有限制。因此，这部分中断相关API只对内核态提供。

设备驱动程序还需要访问物理内存（例如DMA或MMIO的情况）。虽然内核可以提供虚拟内存相关的API，但也可能选择在内核态限制使用这些API。（？）

此外，驱动程序的一些行业标准规定的功能中，某些是可以被用户态程序利用的。
