# 操作系统大赛项目当前进度

时间：2024/3/15

## 选题描述（摘录比赛网站的原文）

### 题目

异步操作系统中的进程、线程和协程调度

### 描述

在RISC-V平台上利用Rust语言的异步特征，在操作系统内核中设计和实现统一的进程、线程和协程调度器，以提高操作系统整体性能。

### 预期目标

**注意：下面的内容是建议内容，不要求必须全部完成。选择本项目的同学也可与导师联系，提出自己的新想法，如导师认可，可加入预期目标**
在现有 rCore 的基础上，进一步完成如下目标：

- 学习Rust语言：rust语言有协程的支持，可以把异步函数执行视为基本的调度单位（协程），然后由编译器生成这些协程的调度代码。
- 完成教学操作系统[rCore的实验](https://github.com/chyyuu/os_course_info/blob/master/README.md#%E9%9D%9E%E6%AD%A3%E5%BC%8F%E6%8E%A8%E8%8D%90%E7%9A%84%E5%AD%A6%E4%B9%A0%E8%B7%AF%E7%BA%BF)：目的是熟悉rCore的基本结构和核心算法的实现；
- 基于对[异步操作系统设计方案](https://shimo.im/docs/473QyY5re6tvXb3w)的了解，在用户态进程中引入协程支持，同时支持用户态线程；
- 分析用户态进程中的线程和协程的相关数据结构：可能要实现就绪协程的队列和就绪线程的队列，然后实现协程切换和线程切换的统一。
- 尝试在用户态统一线程和协程的调度；
  - 同一线程内的协程切换：rust语言中，在用户态下同一线程内的协程切换的实现已经存在相应的开源用户态线程库。
  - 同一进程内不同线程中的协程切换：不同线程中的协程切换，就要获取协程所在的线程信息，然后进行现成的切换。
  - 不同进程内的协程切换：不同进程中的协程切换，就要获取协程所在的线程和进程信息，然后进行进程的切换。
- 在内核中引入协程支持，同时支持线程切换和协和协程切换；
- 了解内核中协程的调度机制，分析协程相关数据结构；
- 尝试在内核中统一进程、线程和协程的调度；
- 利用协程机制优化内核中的文件系统模块；
- 对比测试引入协程前后的应用程序性能变化；

## 我当前的进度

### 硬件部分

在QEMU模拟器上实现了一个硬件协程调度器/中断控制器（该硬件在FPGA上的实现由赵方亮学长完成）。其功能如下：

- 使用按进程分组的优先级队列，进行每个进程内部带优先级的协程调度。提供了加入某个优先级的协程和取出协程的接口。
- 提供中断处理的协程支持。硬件连接了设备的中断线，系统向硬件中注册中断处理协程，当中断到来时，从对应中断的队列中取出中断处理协程，放入内核进程的调度队列中，使其被执行器取出、执行。*（扩展方向：之后可能会提供让用户进程处理中断的功能。）*
- *还未实现：支持进程间通信的异步机制。每个进程在硬件中维护不同类型消息的处理队列，当其它进程通过该硬件向进程发送对应消息时，则将处理队列中的一个协程放入调度队列。*

硬件部分的代码位于[https://github.com/ATS-INTC/qemu](https://github.com/ATS-INTC/qemu)中。硬件部分的设计和实现文档位于[https://ats-intc.github.io/docs/](https://ats-intc.github.io/docs/)。

[https://github.com/ATS-INTC/ats-intc](https://github.com/ATS-INTC/ats-intc)仓库的`driver.rs`中，提供了调用硬件的Rust语言接口。此处还提供了表示异步任务的数据结构`Task`，但目前在`ArceOS`中的实现并未使用`Task`。

### 软件部分

本部分的目标是，在`ArceOS`操作系统中开发一个利用硬件调度器的任务调度与执行机制，并且在该机制基础上实现对网卡的异步访问。之后，在其上运行`redis`数据库软件，测试其性能与没有异步机制时的差异。

之前曾用应用程序的方式在`ArceOS`内实现了一个协程执行器（Executor）。因为`ArceOS`为unikernel系统，单地址空间，不区分用户态和内核态，因此作为应用程序的Executor也是在内核中运行。但由于该方案无法运行`redis`，因此放弃。

目前，正在修改`ArceOS`的任务调度机制，使其可以同时进行线程与协程的调度（此处认为线程和协程是平级的，协程不从属于线程）（还未完成）。修改的方案为，为线程实现`Future` trait，让其可以被原本用于协程的`Executor`执行。

等到`ArceOS`内部修改完成，可以使用异步机制运行`redis`时，我就可以开始操作系统大赛方向的开发了。

修改的`ArceOS`位于仓库[https://github.com/ATS-INTC/arceos-ats-intc](https://github.com/ATS-INTC/arceos-ats-intc)中。因为我修改的部分还未完成，因此还未同步进仓库。

## 操作系统大赛选题的可能方向

根据赛题描述，在任务调度方面有这两种扩展的方向：

- 在内核态中，将进程调度引入调度机制，在内核统一调度进程、线程和协程。
- 在用户态中，引入用户态线程，在用户态统一线程和协程调度。

或者大家也可以提出其它方向。

## 相关资料

Rust协程调度的相关：

[200行代码讲透RUST FUTURES](https://stevenbai.top/rust/futures_explained_in_200_lines_of_rust/)，[我的笔记](https://gitee.com/LC_rosy/weekly-progress/blob/master/23.12.5~23.12.11/200%E8%A1%8C%E4%BB%A3%E7%A0%81%E8%A7%A3%E6%9E%90Rust%20Future.md)

[Async/Await | Writing an OS in Rust](https://os.phil-opp.com/async-await/#futures-in-rust)，我的笔记[1](https://gitee.com/LC_rosy/weekly-progress/blob/master/23.12.5~23.12.11/rust%E5%BC%82%E6%AD%A5%E5%8E%9F%E7%90%86.md)、[2](https://gitee.com/LC_rosy/weekly-progress/blob/master/24.1.25~24.2.26/rust%E5%BC%82%E6%AD%A5%E5%8E%9F%E7%90%86%E4%B8%AD%E7%9A%84executor%E5%AE%9E%E7%8E%B0.md)

[我对Rust协程机制的总结](https://gitee.com/LC_rosy/weekly-progress/blob/master/24.1.25~24.2.26/%E6%80%BB%E7%BB%93%EF%BC%9Afuture%E5%92%8Cexecutor%E7%9A%84%E8%A1%8C%E4%B8%BA.md)