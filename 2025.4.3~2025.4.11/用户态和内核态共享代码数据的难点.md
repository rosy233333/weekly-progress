# 用户态和内核态共享代码数据的难点

时间：2025.4.10

这些问题都会在实现vdso机制时遇到。

## 1. 地址空间不同

对于用户态和内核态共享的数据而言，由于要在不同的地址空间中访问同一个物理地址，因此需要达到两种条件之一：

1. 不能使用指针等包含间接地址引用的数据；
2. 将其中的所有间接地址引用改为“基地址无关”的形式，例如使用`数据段基址+段内偏移`寻址，存储的间接地址引用均为段内偏移，数据段基址通过一些方式在运行时获得。

这里的问题与在共享内存中存储指针时遇到的问题类似。

（注：如果数据不需要在用户态和内核态共享，那很简单。就像多进程使用共享库一样，用户态和内核态各持有一份数据的拷贝即可。重定位时用到的PLT就属于“不需共享的数据”）

## 2. 同步机制的难点

没有同时适用于用户态和内核态的锁。用户态的临界区对内核态不起作用，在用户态持有锁时发生中断会导致内核态无法访问加锁的数据，进而可能导致中断无法返回，造成死锁。

## \*堆分配器

堆分配器会遇到1和2两个问题，但其又对数据结构和代码十分重要。

或者，如果能保证在中断处理程序中不访问共享堆分配器，则可以在堆分配器中加锁。

## 3. 系统功能

一些系统功能的API在用户态和内核态不统一（例如，可能用户态需要进行系统调用，而内核态则可以直接调用函数）。因此，可能一些使用了系统功能的代码无法正常运行。
