# 网络驱动学习

时间：2023/3/24

## 中断（Interrupt）模式和轮询（Poll）模式

中断模式，网络硬件主动发出中断，操作系统接收到中断后，调用处理程序处理中断。

轮询模式，操作系统主动查询网络硬件的状态，并且进行相应的操作。

中断模式一般用于网络层，网络硬件接收到数据包后向操作系统发出中断，使其处理该数据包。

## ArceOS网络驱动中，两个涉及到任务切换的层次

### 传输层（？）

modules/axnet/src/smoltcp_impl/tcp.rs

该层处理的对象为Socket。对Socket执行的某些操作（例如发送消息、接收消息、等待一个连接）由于某些原因无法马上完成，在block模式下，会先调用`yield_now`切换到别的任务，等待切回来后再重试该操作。

属于轮询模式。

### 网络层（？）

该层处理的对象为数据包。

数据包的收取：根据virtio设备的机制，将数据包放在used ring中。
Socket调用接收函数，若接收缓冲区没有数据，则会切换任务。切回自己的任务时，会调用一次`poll_interface`函数，逐级轮询，最终从used ring中接收数据包并处理，放置到各个Socket的接收缓冲区中（`smoltcp/src/iface/interface/mod.rs: socket_ingress`）。

数据包的发送：Socket调用发送函数，若发送缓冲区满，则会切换任务。切回自己的任务时，会调用一次`poll_interface`函数，将发送缓冲区的内容调用设备发送出去（`smoltcp/src/iface/interface/mod.rs: socket_egress`）。

## 杂项

smoltcp库支持异步，之后看能否利用这一点。