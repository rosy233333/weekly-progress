# 移植工作方案

时间：2024/10/14

## 项目描述

将zfl学长的工作内容“操作系统中的线程协程协同调度”移植到clf学长的工作内容“带有域隔离功能的Alien操作系统”中。

## 相关内容介绍

### zfl学长的工作

zfl学长的工作分为两部分。第一部分，是一个在硬件上实现（也可用QEMU模拟实现或在操作系统层面用软件实现）一个结合了任务调度功能和中断处理功能的模块。第二部分，是在操作系统中实现系统级的协程支持，其中包括将一些I/O功能改造为协程实现。

我的移植工作只涉及第二部分，即是线程协程协同调度的部分。

### clf学长的工作

clf学长在他开发的Alien操作系统中增加了对隔离域的支持。该特性使得Alien系统与一般的模块化操作系统相比有以下特点：

- 支持域和操作系统分别编译、域的动态加载和替换。
- 各个域之间有定义更明确的接口。

这些特性方便了我的移植工作。

## 技术路线

该部分的移植分为两部分：任务模块中的协程支持，以及其它模块的异步改造。

### 任务模块的协程支持

需要实现协程的调度运行支持，以及对外提供协程相关接口。

- **了解Alien系统的任务相关接口，包括TCB、调度器、切换机制等**已完成

- **了解async-os的任务相关接口，以及其中各个模块对本系统专有模块的依赖情况**从而确定更详细的方案

#### 协程的调度运行支持

**修改`TaskMeta`中使用的`TaskContext`字段和`kernel/task`中的`switch`和`cpu_loop`，实现线程和协程的兼容。** 这部分代码可以参考zfl学长的AsyncStarry。（使用AsyncStarry而非AsyncOS是因为前者可以实现线程和协程同时运行，而后者通过编译选项控制线程实现还是协程实现）

需要考虑的问题：任务状态（沿用Alien的，考虑能否适配协程的引入）、任务切换函数的调用环境（对线程而言，在线程内调用；对协程而言，在协程外调用）、栈的处理

预估完成时间：1周

#### 提供协程相关接口

暂时没有详细设计

### 其它模块的异步改造

移植后的任务模块需要同时支持线程和协程，这样就不需要将系统的其它部分全部改成协程，甚至可在其它模块的协程改造开始前就得到可以运行的系统，从而起到测试的作用。

## 难点

### 修改任务模块时，哪些模块沿用系统原有代码，哪些模块使用async-os的代码的问题

粗略设计，可以只修改`TaskMeta`的任务上下文字段，以及`kernel/src/task`中任务切换的部分？

### 选择系统模块异步改造的范围

异步改造一个模块（例如Mutex）可能会导致与其相关的其它模块也需要改造为异步语法，牵一发动全身。可能的缓解方式是同时提供同步和异步的接口，从而只在需要异步改造的位置调用异步接口，其它部分调用同步接口

**可以参考async-os中选择的改造范围**

### 在Alien中进行域的开发，缺少完善的文档

参考lbw的毕设、Alien中已有的域等代码/文档，学习域的开发

项目进行过程中，形成一篇如何进行域开发的说明文档

### （不知是否会涉及）域接口为trait实现，若需要修改或增加异步接口，会涉及trait和async的不兼容

之前zfl学长也遇到过这个问题，之后可以去了解他的解决方式
