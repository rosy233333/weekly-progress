# 移植工作方案

时间：2024/10/14

## 项目描述

将zfl学长的工作内容“硬件调度器与中断处理器”和“操作系统中的线程协程协同调度”移植到clf学长的工作内容“带有域隔离功能的Alien操作系统”中。

## 相关内容介绍

### zfl学长的工作

zfl学长的工作分为两部分。第一部分，是一个在硬件上实现（也可用QEMU模拟实现或在操作系统层面用软件实现）一个结合了任务调度功能和中断处理功能的模块。第二部分，是在操作系统中实现系统级的协程支持，其中包括将一些I/O功能改造为协程实现。

两个部分是一个统一的整体。但代码层面上，两个部分的耦合程度低。因此在我的移植工作里，可以把两个部分分开移植。

### clf学长的工作

clf学长在他开发的Alien操作系统中增加了对隔离域的支持。该特性使得Alien系统与一般的模块化操作系统相比有以下特点：

- 支持域和操作系统分别编译、域的动态加载和替换。
- 各个域之间有定义更明确的接口。

这些特性方便了我的移植工作。

## （可供选择的）技术路线

首先，**需要了解Alien系统中与任务调度相关的接口**。

### 硬件调度器的移植

技术路线的不同取决于硬件调度器的实现方式。

- 如果使用QEMU或FPGA上的实现，则可以使用zfl学长的已有实现。（**需要了解学长的已有实现和自己是否有FPGA硬件**）我需要进行的工作只有在Alien系统的任务调度接口中增加对硬件的调用。

- 如果使用软件实现，则在上面提到的工作的基础上，还需要在Alien系统中增加软件实现调度器和中断处理器的相关代码。此时**还需要了解Alien系统中断处理的相关机制**。

### 协程支持的移植

此处的修改因为和操作系统深度绑定，且需要修改的范围比较广泛，因此是移植工作的难点。

该部分的移植也可以分为两部分：任务模块中的协程支持，以及其它模块的异步改造。

#### 任务模块的协程支持

- **了解Alien系统的任务相关接口，包括TCB、调度器、切换机制等**

- **了解async-os的任务相关接口，以及其中各个模块对本系统专有模块的依赖情况**

从而确定更详细的方案

#### 其它模块的异步

移植后的任务模块需要同时支持线程和协程，这样就不需要将系统的其它部分全部改成协程，甚至可在其它模块的协程改造开始前就得到可以运行的系统，从而起到测试的作用。

之后，再选定异步改造的范围。

需要注意，异步改造一个模块（例如Mutex）可能会导致与其相关的其它模块也需要改造为异步语法，牵一发动全身。可能的缓解方式是同时提供同步和异步的接口。

**可以参考async-os中选择的改造范围**