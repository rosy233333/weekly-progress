# zfl学长COPS论文阅读笔记

## Introduction

传统多线程模型的缺点：执行顺序不确定（这是分时、抢占等被动让出方式带来的吗？）、与OS的异步机制不协调，且OS线程无法感知用户态任务

COPS：基于协程的优先级调度框架，支持用户态和内核态统一调度

## Design

![](../图片/屏幕截图%202024-12-18%20231539.png)

用户程序使用协程调度框架可以直接通过函数调用；使用其它操作系统服务则通过系统调用。

![](../图片/屏幕截图%202024-12-18%20235019.png)

协程可能被中断，但不会被抢占。

### 统一调度的实现

时钟中断时，内核更新全局优先级位图，从而**使内核获得对用户进程的感知**。

在内核调度器中使用“切换协程”，用于进入对应的用户进程。其优先级等于用户进程内协程的最高优先级。（该优先级的更新时机是初始化时和时钟中断时）——从而**使得协程调度机制可以应用于进程和协程的两级调度**。

用户进程可以访问全局位图，并在其它进程/内核出现优先级更高的任务时主动让出（下图中“Should yield”），从而**实现进程间的协作式调度**。

![](../图片/屏幕截图%202024-12-19%20000102.png)

## Usage Patterns

### 异步系统调用

在输入参数中增加发起调用的协程id，内核接收到后创建一个协程处理，并立即返回，使用户态得以切换到其它协程。内核协程完成处理后，唤醒发起调用的用户协程。（但是，返回值如何传回用户态？）